<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<script type="text/javascript" src="./js/igVisualizer.min.js"></script>
<script type="text/javascript" src="../d3/d3.min.js"></script>

<!--
`experiment-storage`
Key-value store for experimental data in Arlecchino

@demo demo/index.html 
-->

<dom-module id="experiment-storage">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-button.red {
        margin-bottom: 5px;
        margin-top: 5px;
        background-color: #e2011b;
        color: white;
      }

      paper-button.grey {
        margin-bottom: 5px;
        margin-top: 5px;
        background-color: var(--paper-grey-700);
        color: white;
      }

      paper-dialog {
        width:400px
      }



      .drawer-list a {
        display: block;

        padding: 0 16px;

        text-decoration: none;

        color: var(--app-secondary-color);

        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      a:hover {
        cursor:pointer;
      }

      .sidenav-header {
        font-size:15px;
        line-height:24px;
        display:block;
        padding:5px 30px;
        border-left:4px solid transparent;
      }



      .sidenav-header{font-family:'Roboto Slab', 'Roboto', 'Noto', sans-serif;padding-top:15px;font-weight:bold;border-left:4px solid transparent;}

      .sidenav-header:first-of-type{
        margin-top:15px;
        border-top:1px solid #eceff1;
      }
      .sidenav-endheader{
        margin-top:15px;
        border-bottom:1px solid #eceff1;
      }

      a.iron-selected {
        color:black;
        border-left:4px solid #e2011b;
        color:#e2011b;
      }


</style>


    <div>
      <div class="drawer-list">
        <span class="sidenav-header">Menu</span>
        <a on-click="changeImportState" class=""> Add Experiment</a>
        <a on-click="_removeExperiment"> Remove Selected Experiment</a>
        <a on-click="_removeAll"> Remove All Experiments</a>
      </div>
      <div class="drawer-list">
        <span class="sidenav-header">Download</span>
        <a on-click="_downloadSession"> Download Session</a>
        <a on-click="changeSessionState"> Upload Session</a>
      </div>
      <div class="drawer-list">
        <span class="sidenav-header">Demo</span>
        <a on-click="_loadDemoSession"> Load Demo Experiments</a>
      </div>
      <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
        <p class="sidenav-header">Experiment List</p>
        <template is="dom-repeat" items="[[experimentList]]">
          <a name="[[item.id]]"  href="/tool/[[item.id]]">[[item.name]]</a>
        </template>
      </iron-selector>
    </div>
    <paper-dialog id="dialogimport">
      <h2>Import a new Experiment</h2>
      <div>
        <paper-input id="expname" label="Experiment Name" required="true"></paper-input>
        <paper-input id="expfile" label="Experiment File" type="file"></paper-input>
        <p>
          <paper-button raised class="grey" on-click="uploadExperiment">Upload Experiment</paper-button>
          <paper-button raised class="red" on-click="changeImportState">Cancel</paper-button>
        </p>
      </div>
    </paper-dialog>

    <paper-dialog id="dialogSession">
      <h2>Import a Session File</h2>
      <div>
        <paper-input id="sessionfile" label="Session File" type="file"></paper-input>
        <p>
          <paper-button raised class="grey" on-click="_uploadSession">Upload Session</paper-button>
          <paper-button raised class="red" on-click="changeSessionState">Cancel</paper-button>
        </p>
      </div>
    </paper-dialog>

  </template>

  <script>
    Polymer({

      is: 'experiment-storage',

      properties: {

        experimentList: {
          type: Array,
          value: function() { return []; }
        },

        selectedExperiment: {
          type: Object,
          reflectToAttribute: true,
          observer: "_selectedExperimentChanged"

        },

        experimentId: {
          type: Number,
          reflectToAttribute: true,
          value: 0
        },

        importDialogState:{
          type: Boolean,
          value: false,
          observer: "_importDialogStateChange"
        },

        sessionDialogState:{
          type: Boolean,
          value: false,
          observer: "_sessionDialogStateChange"
        }

      },



      created: function(){
        if(this._lsTest() === true) {
          console.log("LocalStorage check: success");
        } else {
          alert('The LocalStorage is not supported in this browser.');
        }

        if (window.File && window.FileReader && window.FileList && window.Blob) {
          console.log("File APIs check: success");
        } else {
          alert('The File APIs are not fully supported in this browser.');
        }
        //todo: fix loading d3. Must be loaded only if is not present.
      },

      attached: function(){
        if (localStorage.getItem("GlynsightExpList") !== null && localStorage.getItem("GlynsightExpList") !== '') {
          this._reloadFromCache();
        }
      },

      uploadExperiment: function(){
        var expname =this.$.expname;
        var expfile =this.$.expfile;
        var that = this;
        var reader = new FileReader();
        var file = expfile.inputElement.files[0];


        reader.onload = function(e) {
          var glycanMap = {};
          var sumIntensity = 0;
          var experimentInput = {};
          experimentInput.name = expname.value;

          d3.csv.parse(e.target.result, function(dataCSV) {
            var glycan = new igVisualizer.Glycan(dataCSV);
            glycanMap[glycan.composition.toStringNoZeros()] = glycan;
          });
          var expCount = that.experimentList.length;
          if(expCount > 0){
            var lastExpData = JSON.parse(localStorage.getItem(that.experimentList[expCount -1].id)).data;
            for(var i =0; i < lastExpData.nodes.length; i++){
              var node = lastExpData.nodes[i];
                if(glycanMap[node.name]){
                  node.percentage = glycanMap[node.name].percentage;
                } else {
                  node.percentage = -1;
                }
            }
            experimentInput.data = lastExpData;
          } else {
            experimentInput.data = igVisualizer.NetworkBuilder.buildJsonComposition(glycanMap);
          }

          localStorage.setItem('GLYNSIGHTID_'+that.experimentId, JSON.stringify(experimentInput));
          that._updateExpList(experimentInput.name);
          expname.value = '';
          expfile.inputElement.value = '';
        };

        reader.readAsText(file);
        this.changeImportState();
      },

      _updateExpList: function(experimentName){
        var experiment = {};
        experiment.name = experimentName;
        experiment.id = 'GLYNSIGHTID_'+this.experimentId;

        this.push('experimentList', experiment);
        localStorage.setItem('GlynsightExpList',JSON.stringify(this.experimentList));
        this.experimentId++;
      },

      _importDialogStateChange: function(newValue){
        if(newValue){
          this.$.dialogimport.open();
        } else{
          this.$.dialogimport.close();
        }
      },

      _sessionDialogStateChange: function(newValue){
        if(newValue){
          this.$.dialogSession.open();
        } else{
          this.$.dialogSession.close();
        }
      },

      changeImportState: function(){
        this.importDialogState = !this.importDialogState;
      },

      changeSessionState: function(){
        this.sessionDialogState = !this.sessionDialogState;
      },

      _reloadFromCache: function(){
        var cache = JSON.parse(localStorage.getItem("GlynsightExpList"));
        for (var i = 0 ; i< cache.length; i++) {
            this._updateExpList(cache[i].name);
        }
      },

      _lsTest: function(){
        var test = 'test';
        try {
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch(e) {
          return false;
        }
      },

      _selectedExperimentChanged: function (newValue) {
        this.page = newValue.id;
      },

      _removeAll: function(){
        for(var i = 0; i< this.experimentList.length; i++){
          localStorage.removeItem(this.experimentList[i].id);
        }
        localStorage.removeItem("GlynsightExpList");

        this.selectedExperiment = {};
        this.experimentList = [];
        window.location = '/';
      },

      _removeExperiment: function(){
        for(var i = 0; i< this.experimentList.length; i++){
          if(this.experimentList[i].id == this.selectedExperiment.id){
            localStorage.removeItem(this.experimentList[i].id);
            this.splice('experimentList',i, 1);
            localStorage.setItem('GlynsightExpList',JSON.stringify(this.experimentList));
            window.location = '/';
            return;
          }
        }
      },

      _downloadSession: function(){

        var session = {};
        session.expList = localStorage.getItem('GlynsightExpList');

        for(var i = 0; i< this.experimentList.length; i++){
          var id = this.experimentList[i].id;
          session[id] = localStorage.getItem(this.experimentList[i].id);
        }

        var dataSession = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(session));
        var downloadLink = document.createElement("a");

        downloadLink.setAttribute("href",dataSession);
        downloadLink.setAttribute("download", "glynsightSession.json");
        downloadLink.target = "_blank";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      },

      _uploadSession: function(){
        var sessionfile = this.$.sessionfile;
        var that = this;
        var reader = new FileReader();
        var file = sessionfile.inputElement.files[0];

        reader.onload = function(e) {
          that._removeAll();
          var dump = JSON.parse(e.target.result);
          localStorage.setItem('GlynsightExpList',dump.expList);
          for (var key in dump) {
            if(key != 'list'){
              localStorage.setItem(key,dump[key]);
            }
          }
          that._reloadFromCache();
        };


        reader.readAsText(file);
        this.changeSessionState();
      },

      _loadDemoSession: function(){
        var that = this;
        d3.json(this.resolveUrl("./resources/glynsightSession.json"), function(data) {
          that._removeAll();
          localStorage.setItem('GlynsightExpList',data.expList);
          for (var key in data) {
            if(key != 'list'){
              localStorage.setItem(key,data[key]);
            }
          }
          that._reloadFromCache();
        });
      }

    });
  </script>
</dom-module>

